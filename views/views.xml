<?xml version="1.0" encoding="utf-8"?>
<odoo>

    <!-- ============ ACTIONS ============ -->
    <!-- EIMS Settings Action -->
    <record id="action_eims_settings" model="ir.actions.act_window">
        <field name="name">EIMS API Settings</field>
        <field name="res_model">res.config.settings</field>
        <field name="view_mode">list,form</field>
        <field name="target">current</field>
    </record>

    <!-- EIMS Pending Invoices Action -->
    <record id="action_eims_pending_invoices" model="ir.actions.act_window">
        <field name="name">Invoices Pending IRN</field>
        <field name="res_model">account.move</field>
        <field name="view_mode">list,form</field>
        <field name="domain">[('move_type','=','out_invoice'),('eims_irn','=',False),('state','=','posted')]</field>
        <field name="context">{'search_default_eims_pending':1}</field>
        <field name="help" type="html">
            <p class="o_view_nocontent_smiling_face">All invoices have EIMS IRN!</p>
            <p>Invoices that are posted but don't have an EIMS IRN will appear here. You can retry failed integrations or investigate issues.</p>
        </field>
    </record>

    <!-- ============ VIEWS ============ -->

    <!-- 1️⃣ List View Extension -->
    <record id="view_move_list_eims_enhanced" model="ir.ui.view">
        <field name="name">account.move.list.eims.enhanced</field>
        <field name="model">account.move</field>
        <field name="inherit_id" ref="account.view_move_tree"/>
        <field name="arch" type="xml">
            <!-- Insert EIMS status after total amount -->
            <xpath expr="//field[@name='amount_total_signed']" position="after">
                <field name="eims_status" widget="badge" optional="show"
                       options="{'decoration-success':'ok',
                                 'decoration-danger':'failed',
                                 'decoration-info':'sent',
                                 'decoration-muted':'draft'}"/>
            </xpath>
        </field>
    </record>

    <!-- 2️⃣ Form View Extension -->
    <record id="view_move_form_eims_enhanced" model="ir.ui.view">
        <field name="name">account.move.form.eims.enhanced</field>
        <field name="model">account.move</field>
        <field name="inherit_id" ref="account.view_move_form"/>
        <field name="arch" type="xml">
            <!-- Add EIMS fields under existing “Other Info” tab -->
            <xpath expr="//page[@name='other_info']" position="inside">
                <group string="EIMS Integration">
                    <field name="eims_irn"/>
                    <field name="eims_status" widget="badge"
                           options="{'decoration-success':'ok',
                                     'decoration-danger':'failed',
                                     'decoration-info':'sent',
                                     'decoration-muted':'draft'}"/>
                    <field name="eims_error_message" readonly="1"/>
                </group>
            </xpath>
        </field>
    </record>

    <!-- 3️⃣ Search View Extension -->
    <record id="view_move_search_eims_enhanced" model="ir.ui.view">
        <field name="name">account.move.search.eims.enhanced</field>
        <field name="model">account.move</field>
        <field name="inherit_id" ref="account.view_account_invoice_filter"/>
        <field name="arch" type="xml">
            <!-- Add new EIMS filters safely -->
            <xpath expr="//filter[last()]" position="after">
                <separator/>
                <filter string="EIMS Success" name="eims_success" domain="[('eims_status','=','ok')]"/>
                <filter string="EIMS Failed" name="eims_failed" domain="[('eims_status','=','failed')]"/>
                <filter string="EIMS Pending" name="eims_pending" domain="[('eims_status','in',['pending','sent'])]"/>
                <filter string="No EIMS IRN" name="no_eims_irn" domain="[('eims_irn','=',False)]"/>
            </xpath>

            <!-- Add group-by safely -->
            <xpath expr="/search" position="inside">
                <group expand="0" string="Group By">
                    <filter string="EIMS Status" name="group_eims_status"
                            context="{'group_by':'eims_status'}"/>
                </group>
            </xpath>
        </field>
    </record>

</odoo>
